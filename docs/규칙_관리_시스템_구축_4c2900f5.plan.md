---
name: Rulebook 시스템 구축 (플랫폼 독립적)
overview: AI 작업 중 발견한 규칙을 즉시 체계적으로 관리할 수 있는 플랫폼 독립적인 Rulebook 시스템을 구축합니다. YAML 기반 규칙 저장소를 핵심으로 하며, Cursor(.cursorrules)와 Claude Code(.claude/rules/) 모두 지원하는 어댑터를 통해 각 플랫폼에 동기화합니다.
todos:
  - id: create-rule-structure
    content: 규칙 저장소 디렉토리 구조 생성 (rules/ 디렉토리 및 하위 카테고리 폴더)
    status: pending
  - id: define-rule-schema
    content: 규칙 스키마 TypeScript 타입 정의 (types.ts)
    status: pending
  - id: create-rule-index
    content: 규칙 인덱스 파일 구조 및 스키마 정의 (index.yaml)
    status: pending
  - id: implement-rule-manager
    content: 규칙 관리자 구현 (로드/저장/인덱스 관리)
    status: pending
  - id: implement-rule-search
    content: 규칙 검색 엔진 구현 (태그 기반 + 의미 기반)
    status: pending
  - id: implement-add-rule
    content: 대화형 규칙 추가 프로세스 구현
    status: pending
  - id: implement-duplicate-detection
    content: 기존 규칙 중복 감지 로직 구현
    status: pending
  - id: create-rule-templates
    content: 각 카테고리별 규칙 파일 템플릿 생성
    status: pending
  - id: integrate-ai-workflow
    content: AI 에이전트와 규칙 발견/추가 워크플로우 통합
    status: pending
  - id: sync-platform-rules
    content: 플랫폼별 규칙 동기화 어댑터 구현 (Cursor .cursorrules, Claude Code .claude/rules/)
    status: pending
  - id: implement-hierarchy
    content: 계층적 규칙 해석 및 병합 로직 구현 (글로벌 → 프로젝트 → 패키지)
    status: pending
  - id: implement-conflict-resolution
    content: 규칙 충돌 해결 전략 구현 (local-wins, merge, ask-user)
    status: pending
---

# Rulebook 시스템 구축 계획 (플랫폼 독립적)

## 1. 목표

AI 작업 중 발견하는 규칙을 즉시 체계적으로 관리하고, 기존 규칙이 있으면 보완하고 없으면 추가할 수 있는 **플랫폼 독립적인 Rulebook** 시스템을 구축합니다. Cursor와 Claude Code 모두에서 사용 가능합니다.

## 2. 아키텍처

### 2.1 계층적 규칙 구조 (Hierarchical Rule System)

규칙은 계층적으로 관리되며, 하위 레벨 규칙이 상위 레벨 규칙을 오버라이드합니다:

```
Work/ (글로벌 레벨 - 최하위 우선순위)
├── rules/                          # 글로벌 규칙
│   ├── index.yaml
│   ├── code/
│   └── workflow/
│
└── camfit-playground/ (프로젝트 레벨)
    ├── rules/                      # 프로젝트별 규칙 (글로벌 오버라이드)
    │   ├── index.yaml
    │   ├── code/
    │   └── workflow/
    │
    └── packages/work-kernel/ (하위 프로젝트 레벨)
        └── rules/                  # 패키지별 규칙 (최고 우선순위)
            ├── index.yaml
            └── code/
```

**우선순위 (높은 것부터)**:

1. **현재 작업 디렉토리**의 `rules/` (가장 구체적)
2. **프로젝트 루트**의 `rules/` (프로젝트별)
3. **글로벌 루트**의 `rules/` (기본값)

### 2.2 규칙 해석 전략

```typescript
interface RuleResolutionStrategy {
  // 병합 전략
  mergeStrategy: 'override' | 'merge' | 'extend';
  
  // 충돌 해결
  conflictResolution: 'local-wins' | 'global-wins' | 'ask-user';
  
  // 규칙 범위
  scope: 'global' | 'project' | 'package' | 'file';
}
```

**규칙 병합 예시**:

```yaml
# Work/rules/code/naming.yaml (글로벌)
rules:
  - id: RUL-CODE-001
    name: "함수 네이밍"
    description: "camelCase 사용"
    severity: warning

# camfit-playground/rules/code/naming.yaml (프로젝트)
rules:
  - id: RUL-CODE-001  # 같은 ID
    name: "함수 네이밍"
    description: "camelCase 사용, 단 TypeScript는 PascalCase 허용"
    severity: error  # 프로젝트에서 더 엄격하게
    exceptions:
      - "TypeScript 클래스는 PascalCase"
```

**결과**: 프로젝트 레벨 규칙이 적용됨 (더 구체적이므로)

### 2.3 플랫폼 독립적 핵심 구조

```
프로젝트 루트/
├── rules/                          # 핵심 규칙 저장소 (플랫폼 독립)
│   ├── index.yaml                  # 규칙 인덱스 및 메타데이터
│   ├── .rulebook-config.yaml      # 규칙 설정 (계층 정보 포함)
│   ├── code/                       # 코드 관련 규칙
│   │   ├── style.yaml
│   │   ├── naming.yaml
│   │   └── patterns.yaml
│   ├── workflow/                   # 워크플로우 규칙
│   │   ├── git.yaml
│   │   ├── ai.yaml
│   │   └── collaboration.yaml
│   ├── team/                       # 팀 규칙
│   │   └── conventions.yaml
│   └── security/                   # 보안 규칙
│       └── guidelines.yaml
│
├── .cursorrules                    # Cursor 전용 (선택적 동기화)
└── .claude/rules/                  # Claude Code 전용 (선택적 동기화)
    ├── coding.md
    ├── workflow.md
    └── ...
```

### 2.2 플랫폼 어댑터 패턴

```
┌─────────────────────────────────────┐
│   RulebookManager (핵심)            │
│   - YAML 기반 규칙 저장소           │
│   - 플랫폼 독립적                   │
└──────────────┬──────────────────────┘
               │
       ┌───────┴───────┐
       │               │
       ▼               ▼
┌─────────────┐  ┌─────────────┐
│ Cursor      │  │ Claude Code  │
│ Adapter     │  │ Adapter      │
│             │  │              │
│ .cursorrules│  │ .claude/     │
│ 동기화      │  │ rules/*.md   │
│             │  │ 동기화       │
└─────────────┘  └─────────────┘
```

### 2.3 규칙 스키마

각 규칙은 다음 구조를 가집니다:

```yaml
# rules/code/naming.yaml 예시
rules:
 - id: RUL-CODE-001
    name: "함수 네이밍 규칙"
    description: "함수명은 동사로 시작하고 camelCase를 사용합니다"
    category: code
    tags:
   - naming
   - functions
   - javascript
    severity: error  # error | warning | info
    examples:
      good:
    - "calculateTotal()"
    - "getUserById()"
      bad:
    - "total()"
    - "user_by_id()"
    exceptions:
   - "생성자 함수는 PascalCase 사용"
    related:
   - RUL-CODE-002
    created: "2026-01-17"
    updated: "2026-01-17"
    context: "TypeScript 프로젝트에서 함수 네이밍 일관성 유지"
```

### 2.4 규칙 설정 파일

```yaml
# rules/.rulebook-config.yaml
metadata:
  version: "1.0.0"
  scope: "project"  # global | project | package
  parentScope: "../rules"  # 상위 규칙 경로 (선택적)

hierarchy:
  enabled: true
  mergeStrategy: "override"  # override | merge | extend
  conflictResolution: "local-wins"  # local-wins | global-wins | ask-user

inheritance:
  - path: "../../rules"  # 글로벌 규칙 경로
    priority: 1  # 낮은 숫자가 낮은 우선순위
  - path: "../rules"  # 상위 프로젝트 규칙
    priority: 2
```

### 2.5 규칙 인덱스

```yaml
# rules/index.yaml
metadata:
  version: "1.0.0"
  lastUpdated: "2026-01-17T10:00:00Z"
  scope: "project"  # 이 인덱스의 범위

categories:
 - id: code
    name: "코드 규칙"
    description: "코딩 스타일, 네이밍, 패턴 등"
    files:
   - code/style.yaml
   - code/naming.yaml
   - code/patterns.yaml
 - id: workflow
    name: "워크플로우 규칙"
    description: "Git, AI 사용, 협업 프로세스 등"
    files:
   - workflow/git.yaml
   - workflow/ai.yaml
   - workflow/collaboration.yaml

tags:
 - naming
 - functions
 - git
 - ai
 - security
  # ... 동적 태그 목록

rules:
 - id: RUL-CODE-001
    file: code/naming.yaml
    category: code
    tags: [naming, functions]
    summary: "함수 네이밍 규칙"
    scope: "project"  # 이 규칙의 범위
    overrides: ["RUL-CODE-001"]  # 오버라이드하는 상위 규칙 ID
```

## 3. 핵심 기능

### 3.1 규칙 검색 및 중복 확인

- **의미 기반 검색**: 새 규칙 제안 시 유사한 기존 규칙 검색
- **태그 매칭**: 태그 기반으로 관련 규칙 찾기
- **중복 감지**: 유사도 임계값(예: 80%) 이상이면 기존 규칙으로 판단

### 3.2 규칙 추가/수정 워크플로우

**대화형 프로세스**:

1. AI가 규칙 발견 → 사용자에게 알림
2. AI가 규칙 제안 (카테고리, 태그, 설명 포함)
3. 기존 규칙 검색 및 표시
4. 사용자 선택:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 새 규칙 추가
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 기존 규칙 보완
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 취소

5. 규칙 파일 업데이트
6. 플랫폼별 동기화 (선택적)

### 3.3 플랫폼별 동기화

- **Cursor**: `.cursorrules` 파일에 요약 추가 또는 참조
- **Claude Code**: `.claude/rules/` 디렉토리에 Markdown 파일 생성/업데이트
- **자동 동기화**: 규칙 추가/수정 시 선택적으로 플랫폼별 파일 업데이트

## 4. 구현 파일

### 4.1 Rulebook 관리자 (핵심)

**파일**: `camfit-playground/packages/work-kernel/src/rulebook/rulebook-manager.ts`

주요 기능:

- 규칙 로드/저장 (YAML 기반)
- **계층적 규칙 해석** (글로벌 → 프로젝트 → 패키지)
- **규칙 병합 및 충돌 해결**
- 규칙 검색 (의미 기반 + 태그)
- 중복 감지
- 카테고리 자동 분류
- 인덱스 관리

**계층적 규칙 로드**:

```typescript
async loadRulesForPath(workingPath: string): Promise<Rule[]> {
  // 1. 현재 디렉토리부터 루트까지 rules/ 디렉토리 찾기
  const rulePaths = this.findRulePaths(workingPath);
  
  // 2. 각 레벨의 규칙 로드 (글로벌 → 프로젝트 → 현재)
  const allRules: Map<string, Rule> = new Map();
  
  for (const rulePath of rulePaths) {
    const rules = await this.loadRulesFromPath(rulePath);
    for (const rule of rules) {
      // 같은 ID가 있으면 하위 레벨이 우선 (오버라이드)
      if (!allRules.has(rule.id) || this.isMoreSpecific(rulePath, allRules.get(rule.id)!.source)) {
        allRules.set(rule.id, { ...rule, source: rulePath });
      }
    }
  }
  
  return Array.from(allRules.values());
}
```

### 4.2 플랫폼 어댑터

**파일**: `camfit-playground/packages/work-kernel/src/rulebook/adapters/`

- `cursor-adapter.ts`: Cursor `.cursorrules` 동기화
- `claude-adapter.ts`: Claude Code `.claude/rules/` 동기화
- `platform-adapter.ts`: 공통 어댑터 인터페이스

### 4.3 규칙 추가 워크플로우

**파일**: `camfit-playground/packages/work-kernel/src/rulebook/add-rule.ts`

주요 기능:

- 대화형 규칙 추가 프로세스
- 기존 규칙 검색 및 표시
- 사용자 확인 후 파일 업데이트
- 플랫폼별 동기화 호출

### 4.4 규칙 검색 엔진

**파일**: `camfit-playground/packages/work-kernel/src/rulebook/rule-search.ts`

주요 기능:

- 의미 기반 검색 (LLM 활용 가능)
- 태그 기반 필터링
- 유사도 계산

### 4.5 규칙 스키마 정의

**파일**: `camfit-playground/packages/work-kernel/src/rulebook/types.ts`

TypeScript 타입 정의:

- `Rule`
- `RuleCategory`
- `RuleIndex`
- `RuleSearchResult`
- `PlatformAdapter` 인터페이스

## 5. 플랫폼 어댑터 상세

### 5.1 Cursor Adapter

```typescript
export class CursorAdapter implements PlatformAdapter {
  async syncRule(rule: Rule, rulesPath: string): Promise<void> {
    const cursorRulesPath = path.join(rulesPath, '..', '.cursorrules');
    
    // .cursorrules에 규칙 요약 추가 또는 참조
    const summary = this.generateSummary(rule);
    await this.appendToCursorRules(cursorRulesPath, summary);
  }

  private generateSummary(rule: Rule): string {
    return `\n## ${rule.name}\n${rule.description}\n`;
  }
}
```

### 5.2 Claude Code Adapter

```typescript
export class ClaudeAdapter implements PlatformAdapter {
  async syncRule(rule: Rule, rulesPath: string): Promise<void> {
    const claudeRulesPath = path.join(rulesPath, '..', '.claude', 'rules');
    const fileName = this.getFileName(rule.category);
    const filePath = path.join(claudeRulesPath, fileName);

    // Markdown 형식으로 규칙 추가
    const markdown = this.ruleToMarkdown(rule);
    await this.appendToFile(filePath, markdown);
  }

  private ruleToMarkdown(rule: Rule): string {
    return `\n## ${rule.name}\n\n${rule.description}\n\n` +
           `**태그**: ${rule.tags.join(', ')}\n` +
           `**심각도**: ${rule.severity}\n`;
  }
}
```

## 6. 통합 포인트

### 6.1 AI 에이전트 통합

AI가 규칙을 발견했을 때:

1. `rulebook.detectRule()` 호출
2. 기존 규칙 검색
3. 사용자에게 제안 표시
4. 승인 시 `rulebook.addRule()` 또는 `rulebook.updateRule()` 호출
5. 선택적으로 플랫폼 어댑터를 통해 동기화

### 6.2 플랫폼 감지

```typescript
export function detectPlatform(): 'cursor' | 'claude' | 'unknown' {
  // Cursor 감지
  if (process.env.CURSOR_SESSION_ID) {
    return 'cursor';
  }
  
  // Claude Code 감지
  if (process.env.CLAUDE_API_KEY || fs.existsSync('.claude/settings.json')) {
    return 'claude';
  }
  
  return 'unknown';
}
```

## 7. 사용 예시

### 7.1 규칙 발견 시나리오

```
[AI] 작업 중 다음 규칙을 발견했습니다:
"커밋 메시지는 항상 conventional commits 형식을 따라야 합니다"

기존 규칙 검색 중...
→ 유사한 규칙 발견: RUL-WORKFLOW-001 (커밋 메시지 형식)

[선택지]
1. 기존 규칙 보완 (예시 추가)
2. 새 규칙으로 추가
3. 취소

사용자: 1 선택

[AI] 기존 규칙에 다음 내용을 추가합니다:
- 예시: "feat: 로그인 기능 추가"
- 예외: "hotfix는 'hotfix:' 접두사 사용"

플랫폼 동기화 중...
→ Cursor: .cursorrules 업데이트 완료
→ Claude Code: .claude/rules/workflow.md 업데이트 완료
```

### 7.2 규칙 조회

```typescript
// 카테고리로 조회
const codeRules = rulebook.getRulesByCategory('code');

// 태그로 조회
const namingRules = rulebook.getRulesByTags(['naming', 'functions']);

// 검색
const results = rulebook.search('커밋 메시지 형식');
```

## 8. 구현 단계

1. **Phase 1**: 기본 구조 및 스키마 정의

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 규칙 디렉토리 구조 생성
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - TypeScript 타입 정의
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 기본 YAML 파일 템플릿

2. **Phase 2**: 규칙 관리 핵심 기능

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 규칙 로드/저장
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 인덱스 관리
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 기본 검색 (태그 기반)

3. **Phase 3**: 플랫폼 어댑터

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Cursor 어댑터 구현
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - Claude Code 어댑터 구현
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 플랫폼 감지 로직

4. **Phase 4**: AI 통합

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 의미 기반 검색
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 중복 감지
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 대화형 추가 프로세스

5. **Phase 5**: 고도화

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 자동 카테고리 분류
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 규칙 버전 관리
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - 규칙 사용 통계

## 9. 참고 파일

- 기존 `.cursorrules`: [/Users/kent/Work/Camfit/.cursorrules](.cursorrules)
- Claude Code 규칙 예시: `camfit-nestrapi/.claude/rules/coding.md`
- Playbook PRD: `camfit-playground/reinforcement-plan/cc-plan/modules/playbook.md`
- 파일 유틸리티: `camfit-playground/packages/work-kernel/src/shared/fs-utils.ts`
- work-kernel 패키지: `camfit-playground/packages/work-kernel/`

## 10. 계층적 규칙 관리 상세

### 10.1 규칙 해석 알고리즘

```
현재 작업 디렉토리에서 시작
    │
    ▼
상위 디렉토리로 이동하며 rules/ 디렉토리 탐색
    │
    ├─→ 현재 디렉토리에 rules/ 있음?
    │   │
    │   └─→ YES: 로드 (우선순위 1)
    │
    ├─→ 프로젝트 루트에 rules/ 있음?
    │   │
    │   └─→ YES: 로드 (우선순위 2)
    │
    └─→ 글로벌 루트에 rules/ 있음?
        │
        └─→ YES: 로드 (우선순위 3)

규칙 병합:
- 같은 ID의 규칙이 여러 레벨에 있으면
- 더 구체적인 레벨(우선순위 높은)의 규칙이 적용
- 또는 mergeStrategy에 따라 병합
```

### 10.2 충돌 해결 전략

```typescript
interface ConflictResolution {
  // 같은 ID의 규칙이 여러 레벨에 있을 때
  strategy: 'local-wins' | 'global-wins' | 'merge' | 'ask-user';
  
  // merge 전략일 때
  mergeOptions?: {
    description: 'append' | 'replace';
    severity: 'max' | 'min' | 'local';
    tags: 'union' | 'intersection' | 'local';
    examples: 'append' | 'replace';
  };
}
```

**예시: local-wins 전략**

```yaml
# Work/rules/code/naming.yaml
- id: RUL-CODE-001
  severity: warning

# camfit-playground/rules/code/naming.yaml  
- id: RUL-CODE-001
  severity: error  # 프로젝트 레벨이 우선 → error 적용
```

**예시: merge 전략**

```yaml
# Work/rules/code/naming.yaml
- id: RUL-CODE-001
  tags: [naming, functions]
  examples:
    good: ["calculateTotal()"]

# camfit-playground/rules/code/naming.yaml
- id: RUL-CODE-001
  tags: [naming, functions, typescript]  # 추가 태그
  examples:
    good: ["calculateTotal()", "getUserById()"]  # 추가 예시

# 결과: 병합됨
- id: RUL-CODE-001
  tags: [naming, functions, typescript]
  examples:
    good: ["calculateTotal()", "getUserById()"]
```

### 10.3 규칙 범위 지정

규칙에 `scope` 필드를 추가하여 적용 범위를 명시:

```yaml
rules:
  - id: RUL-CODE-001
    name: "함수 네이밍"
    scope: "project"  # 이 프로젝트에만 적용
    # 또는
    scope: "global"  # 모든 프로젝트에 적용
    # 또는
    scope: "package:work-kernel"  # 특정 패키지에만
```

## 11. 설계 원칙

1. **플랫폼 독립성**: 핵심 시스템은 어떤 AI 도구에서도 작동
2. **확장성**: 새로운 플랫폼 추가 시 어댑터만 구현
3. **선택적 동기화**: 플랫폼별 파일 동기화는 선택 사항
4. **계층적 관리**: 글로벌 → 프로젝트 → 패키지 순서로 규칙 적용
5. **충돌 해결**: 명확한 우선순위와 병합 전략 제공
6. **하위 호환성**: 기존 `.cursorrules` 및 `.claude/rules/` 파일과 호환